<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€¼ç­è°ƒä¼‘è®°å½•å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }
        body {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .summary {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            text-align: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .summary-item {
            background: #e8f4f8;
            padding: 20px;
            border-radius: 8px;
            width: 28%;
            min-width: 150px;
        }
        .summary-item h3 {
            color: #444;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .summary-item .num {
            font-size: 28px;
            font-weight: bold;
            color: #2c7fb8;
        }
        .operate-area {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .operate-area h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }
        .date-select {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .date-select label {
            font-size: 16px;
            font-weight: 500;
        }
        .date-select input {
            padding: 8px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 200px;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .file-btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            padding-top: 15px;
            border-top: 1px dashed #ddd;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .add-duty-full {
            background: #5cb85c;
            color: white;
        }
        .add-duty-half {
            background: #449d44;
            color: white;
        }
        .use-rest-half {
            background: #f0ad4e;
            color: white;
        }
        .use-rest-full {
            background: #d9534f;
            color: white;
        }
        .export-btn {
            background: #337ab7;
            color: white;
        }
        .import-btn {
            background: #2e6da4;
            color: white;
        }
        .delete-btn {
            background: #dc3545;
            color: white;
            padding: 5px 10px;
            font-size: 14px;
            margin-left: 10px;
        }
        button:hover {
            opacity: 0.9;
        }
        .record-list {
            margin-top: 30px;
        }
        .record-list h3 {
            margin-bottom: 15px;
            color: #333;
        }
        .record-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .record-item .main-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .record-item .type-area {
            display: flex;
            align-items: center;
        }
        .record-item .type {
            font-weight: bold;
            font-size: 16px;
        }
        .record-item .date {
            color: #2c7fb8;
            font-weight: 500;
            margin-right: 10px;
        }
        .record-item .detail {
            color: #666;
            font-size: 14px;
        }
        .reset-btn {
            background: #777;
            color: white;
            margin-top: 20px;
        }
        .empty-tip {
            text-align:center; 
            color:#999; 
            padding:20px;
        }
        /* éšè—æ–‡ä»¶è¾“å…¥æ¡† */
        #file-input {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å€¼ç­è°ƒä¼‘è®°å½•å·¥å…·</h1>
        
        <!-- æ±‡æ€»ä¿¡æ¯ -->
        <div class="summary">
            <div class="summary-item">
                <h3>æ€»å€¼ç­æ—¶é•¿</h3>
                <div class="num" id="total-duty">0.0</div>
                <div>å¤©</div>
            </div>
            <div class="summary-item">
                <h3>å·²ç”¨è°ƒä¼‘æ—¶é•¿</h3>
                <div class="num" id="used-rest">0.0</div>
                <div>å¤©</div>
            </div>
            <div class="summary-item">
                <h3>å‰©ä½™è°ƒä¼‘æ—¶é•¿</h3>
                <div class="num" id="left-rest">0.0</div>
                <div>å¤©</div>
            </div>
        </div>

        <!-- æ“ä½œåŒºåŸŸ -->
        <div class="operate-area">
            <h3>æ–°å¢è®°å½•</h3>
            <div class="date-select">
                <label for="operate-date">é€‰æ‹©æ—¥æœŸï¼š</label>
                <input type="date" id="operate-date" value="">
            </div>
            <div class="btn-group">
                <button class="add-duty-full" onclick="addDuty(1)">è®°å½•1å¤©å€¼ç­</button>
                <button class="add-duty-half" onclick="addDuty(0.5)">è®°å½•åŠå¤©å€¼ç­</button>
                <button class="use-rest-half" onclick="useRest(0.5)">è®°å½•åŠå¤©è°ƒä¼‘</button>
                <button class="use-rest-full" onclick="useRest(1)">è®°å½•1å¤©è°ƒä¼‘</button>
            </div>
            
            <!-- æ–°å¢æ–‡ä»¶å¯¼å‡º/å¯¼å…¥æŒ‰é’® -->
            <div class="file-btn-group">
                <button class="export-btn" onclick="exportRecords()">ğŸ“¤ å¯¼å‡ºè®°å½•åˆ°æ–‡ä»¶</button>
                <button class="import-btn" onclick="document.getElementById('file-input').click()">ğŸ“¥ ä»æ–‡ä»¶å¯¼å…¥è®°å½•</button>
                <input type="file" id="file-input" accept=".txt,.json" onchange="importRecords(event)">
            </div>
        </div>

        <!-- è®°å½•åˆ—è¡¨ -->
        <div class="record-list">
            <h3>è¯¦ç»†è®°å½•</h3>
            <div id="record-container"></div>
        </div>

        <!-- é‡ç½®æŒ‰é’® -->
        <button class="reset-btn" onclick="resetAll()" style="display: block; margin: 20px auto 0;">é‡ç½®æ‰€æœ‰è®°å½•</button>
    </div>

    <script>
        // åˆå§‹åŒ–æ•°æ®ï¼ˆæœ¬åœ°å­˜å‚¨ï¼‰
        let data = JSON.parse(localStorage.getItem('dutyRestRecord')) || {
            totalDuty: 0,    // æ€»å€¼ç­å¤©æ•°ï¼ˆæ”¯æŒ0.5ï¼‰
            usedRest: 0,     // å·²ç”¨è°ƒä¼‘å¤©æ•°ï¼ˆæ”¯æŒ0.5ï¼‰
            records: []      // æ“ä½œè®°å½•
        };

        // é¡µé¢åŠ è½½æ—¶è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©ï¼Œå¹¶æ›´æ–°æ˜¾ç¤º
        window.onload = function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('operate-date').value = today;
            updateDisplay();
            renderRecords();
        };

        // æ–°å¢å€¼ç­ï¼ˆæ”¯æŒ1å¤©/0.5å¤©ï¼‰
        function addDuty(dutyDays) {
            const selectedDate = getSelectedDate();
            if (!selectedDate) return;

            // æ£€æŸ¥è¯¥æ—¥æœŸæ˜¯å¦å·²è®°å½•è¿‡ç›¸åŒæ—¶é•¿çš„å€¼ç­
            const isDuplicate = data.records.some(item => 
                item.date === selectedDate && 
                item.type === 'å€¼ç­' && 
                item.content === `${dutyDays}å¤©`
            );
            if (isDuplicate) {
                alert(`âš ï¸ ${selectedDate} å·²è®°å½•è¿‡${dutyDays}å¤©å€¼ç­ï¼Œè¯·å‹¿é‡å¤æ·»åŠ ï¼`);
                return;
            }

            data.totalDuty += dutyDays;
            // ä¿ç•™1ä½å°æ•°ï¼Œé¿å…0.5+0.5=1.0è€Œé1çš„æ˜¾ç¤ºé—®é¢˜
            data.totalDuty = parseFloat(data.totalDuty.toFixed(1));
            
            addRecord('å€¼ç­', `${dutyDays}å¤©`, selectedDate);
            saveData();
            updateDisplay();
            alert(`âœ… å·²è®°å½• ${selectedDate} ${dutyDays}å¤©å€¼ç­`);
        }

        // ä½¿ç”¨è°ƒä¼‘ï¼ˆæ”¯æŒ1å¤©/0.5å¤©ï¼‰
        function useRest(restDays) {
            const selectedDate = getSelectedDate();
            if (!selectedDate) return;

            // è®¡ç®—å‰©ä½™è°ƒä¼‘ï¼ˆä¿ç•™1ä½å°æ•°ï¼‰
            const leftRest = parseFloat((data.totalDuty - data.usedRest).toFixed(1));
            
            // æ£€æŸ¥å‰©ä½™è°ƒä¼‘æ˜¯å¦è¶³å¤Ÿ
            if (leftRest < restDays) {
                alert(`âš ï¸ å‰©ä½™è°ƒä¼‘åªæœ‰${leftRest}å¤©ï¼Œä¸è¶³ä»¥æŠµæ‰£${restDays}å¤©ï¼`);
                return;
            }

            // æ£€æŸ¥è¯¥æ—¥æœŸæ˜¯å¦å·²è®°å½•è¿‡ç›¸åŒæ—¶é•¿çš„è°ƒä¼‘
            const isDuplicate = data.records.some(item => 
                item.date === selectedDate && 
                item.type === 'è°ƒä¼‘' && 
                item.content === `${restDays}å¤©`
            );
            if (isDuplicate) {
                alert(`âš ï¸ ${selectedDate} å·²è®°å½•è¿‡${restDays}å¤©è°ƒä¼‘ï¼Œè¯·å‹¿é‡å¤æ·»åŠ ï¼`);
                return;
            }

            data.usedRest += restDays;
            data.usedRest = parseFloat(data.usedRest.toFixed(1));
            
            addRecord('è°ƒä¼‘', `${restDays}å¤©`, selectedDate);
            saveData();
            updateDisplay();
            alert(`âœ… å·²è®°å½• ${selectedDate} ${restDays}å¤©è°ƒä¼‘`);
        }

        // åˆ é™¤å•æ¡è®°å½•
        function deleteRecord(index) {
            // ç¡®è®¤åˆ é™¤
            if (!confirm('âš ï¸ ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼')) {
                return;
            }

            // è·å–è¦åˆ é™¤çš„è®°å½•
            const deletedRecord = data.records[index];
            // æå–æ—¶é•¿ï¼ˆå¦‚"1å¤©"â†’1ï¼Œ"0.5å¤©"â†’0.5ï¼‰
            const days = parseFloat(deletedRecord.content.replace('å¤©', ''));

            // æ ¹æ®è®°å½•ç±»å‹ï¼Œåå‘æ‰£å‡æ€»æ—¶é•¿
            if (deletedRecord.type === 'å€¼ç­') {
                data.totalDuty -= days;
                data.totalDuty = parseFloat(data.totalDuty.toFixed(1));
            } else if (deletedRecord.type === 'è°ƒä¼‘') {
                data.usedRest -= days;
                data.usedRest = parseFloat(data.usedRest.toFixed(1));
            }

            // ä»æ•°ç»„ä¸­åˆ é™¤è¯¥è®°å½•
            data.records.splice(index, 1);
            // ä¿å­˜æ•°æ®å¹¶æ›´æ–°æ˜¾ç¤º
            saveData();
            updateDisplay();
            renderRecords();
            
            alert(`âœ… å·²åˆ é™¤ã€${deletedRecord.date} ${deletedRecord.type} ${deletedRecord.content}ã€‘çš„è®°å½•`);
        }

        // å¯¼å‡ºè®°å½•åˆ°æ–‡æœ¬æ–‡ä»¶
        function exportRecords() {
            if (data.records.length === 0 && data.totalDuty === 0) {
                alert('âš ï¸ æš‚æ— è®°å½•å¯å¯¼å‡ºï¼');
                return;
            }

            // å°†æ•°æ®è½¬ä¸ºæ ¼å¼åŒ–çš„JSONå­—ç¬¦ä¸²ï¼ˆæ–¹ä¾¿é˜…è¯»ï¼‰
            const jsonStr = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonStr], { type: 'text/plain;charset=utf-8' });
            
            // ç”Ÿæˆæ–‡ä»¶åï¼ˆå¸¦æ—¥æœŸï¼‰
            const date = new Date().toISOString().split('T')[0];
            const fileName = `å€¼ç­è°ƒä¼‘è®°å½•_${date}.txt`;

            // åˆ›å»ºä¸‹è½½é“¾æ¥å¹¶è§¦å‘ä¸‹è½½
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = fileName;
            a.click();
            
            // é‡Šæ”¾URLå¯¹è±¡
            URL.revokeObjectURL(a.href);
            alert(`âœ… è®°å½•å·²æˆåŠŸå¯¼å‡ºä¸ºï¼š${fileName}`);
        }

        // ä»æ–‡ä»¶å¯¼å…¥è®°å½•
        function importRecords(event) {
            const file = event.target.files[0];
            if (!file) return;

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.name.endsWith('.txt') && !file.name.endsWith('.json')) {
                alert('âš ï¸ è¯·é€‰æ‹©.txtæˆ–.jsonæ ¼å¼çš„è®°å½•æ–‡ä»¶ï¼');
                // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©æ¡†
                document.getElementById('file-input').value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // è§£æå¯¼å…¥çš„JSONæ•°æ®
                    const importedData = JSON.parse(e.target.result);
                    
                    // éªŒè¯æ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®
                    if (!importedData.hasOwnProperty('totalDuty') || 
                        !importedData.hasOwnProperty('usedRest') || 
                        !importedData.hasOwnProperty('records')) {
                        throw new Error('æ•°æ®æ ¼å¼é”™è¯¯');
                    }

                    // ç¡®è®¤è¦†ç›–ç°æœ‰æ•°æ®
                    if (!confirm('âš ï¸ å¯¼å…¥è®°å½•ä¼šè¦†ç›–å½“å‰æ‰€æœ‰æœ¬åœ°è®°å½•ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
                        document.getElementById('file-input').value = '';
                        return;
                    }

                    // æ›´æ–°æ•°æ®å¹¶ä¿å­˜
                    data = importedData;
                    // ç¡®ä¿æ•°å€¼ç²¾åº¦
                    data.totalDuty = parseFloat(data.totalDuty.toFixed(1));
                    data.usedRest = parseFloat(data.usedRest.toFixed(1));
                    
                    saveData();
                    updateDisplay();
                    renderRecords();
                    
                    alert(`âœ… æˆåŠŸå¯¼å…¥è®°å½•ï¼\n- æ€»å€¼ç­æ—¶é•¿ï¼š${data.totalDuty}å¤©\n- å·²ç”¨è°ƒä¼‘æ—¶é•¿ï¼š${data.usedRest}å¤©`);
                } catch (error) {
                    alert(`âŒ å¯¼å…¥å¤±è´¥ï¼æ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–æ•°æ®æŸåã€‚\né”™è¯¯ä¿¡æ¯ï¼š${error.message}`);
                } finally {
                    // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©æ¡†
                    document.getElementById('file-input').value = '';
                }
            };

            // è¯»å–æ–‡ä»¶å†…å®¹
            reader.readAsText(file, 'utf-8');
        }

        // è·å–é€‰æ‹©çš„æ—¥æœŸå¹¶æ ¡éªŒ
        function getSelectedDate() {
            const dateInput = document.getElementById('operate-date');
            const selectedDate = dateInput.value;
            
            if (!selectedDate) {
                alert('è¯·å…ˆé€‰æ‹©è¦è®°å½•çš„æ—¥æœŸï¼');
                return null;
            }
            return selectedDate;
        }

        // æ·»åŠ æ“ä½œè®°å½•
        function addRecord(type, content, date) {
            const createTime = new Date().toLocaleString(); // è®°å½•æ“ä½œæ—¶é—´
            data.records.unshift({
                type: type,        // ç±»å‹ï¼šå€¼ç­/è°ƒä¼‘
                content: content,  // æ—¶é•¿ï¼š1å¤©/0.5å¤©
                date: date,        // å€¼ç­/è°ƒä¼‘çš„å…·ä½“æ—¥æœŸ
                createTime: createTime // è®°å½•åˆ›å»ºæ—¶é—´
            });
            // åªä¿ç•™æœ€è¿‘100æ¡è®°å½•
            if (data.records.length > 100) {
                data.records.pop();
            }
        }

        // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function saveData() {
            localStorage.setItem('dutyRestRecord', JSON.stringify(data));
        }

        // æ›´æ–°é¡µé¢æ˜¾ç¤º
        function updateDisplay() {
            const leftRest = parseFloat((data.totalDuty - data.usedRest).toFixed(1));
            document.getElementById('total-duty').textContent = data.totalDuty.toFixed(1);
            document.getElementById('used-rest').textContent = data.usedRest.toFixed(1);
            document.getElementById('left-rest').textContent = leftRest;
        }

        // æ¸²æŸ“è¯¦ç»†è®°å½•åˆ—è¡¨
        function renderRecords() {
            const container = document.getElementById('record-container');
            container.innerHTML = '';
            
            if (data.records.length === 0) {
                container.innerHTML = '<div class="empty-tip">æš‚æ— æ“ä½œè®°å½•</div>';
                return;
            }

            // æŒ‰æ—¥æœŸå€’åºæ¸²æŸ“è®°å½•
            data.records.forEach((item, index) => {
                const recordItem = document.createElement('div');
                recordItem.className = 'record-item';
                
                // ä¸»è¦ä¿¡æ¯ï¼ˆç±»å‹+æ—¥æœŸ+åˆ é™¤æŒ‰é’®ï¼‰
                const mainInfo = document.createElement('div');
                mainInfo.className = 'main-info';
                
                // ç±»å‹+æ—¥æœŸåŒºåŸŸ
                const typeArea = document.createElement('div');
                typeArea.className = 'type-area';
                
                const typeSpan = document.createElement('span');
                typeSpan.className = 'type';
                typeSpan.textContent = `${item.type}ï¼š${item.content}`;
                
                const dateSpan = document.createElement('span');
                dateSpan.className = 'date';
                dateSpan.textContent = `(${item.date})`;
                
                // åˆ é™¤æŒ‰é’®
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'åˆ é™¤';
                deleteBtn.onclick = () => deleteRecord(index);
                
                typeArea.appendChild(typeSpan);
                typeArea.appendChild(dateSpan);
                mainInfo.appendChild(typeArea);
                mainInfo.appendChild(deleteBtn);
                
                // è¯¦æƒ…ï¼ˆè®°å½•åˆ›å»ºæ—¶é—´ï¼‰
                const detailSpan = document.createElement('span');
                detailSpan.className = 'detail';
                detailSpan.textContent = `è®°å½•æ—¶é—´ï¼š${item.createTime}`;
                
                recordItem.appendChild(mainInfo);
                recordItem.appendChild(detailSpan);
                container.appendChild(recordItem);
            });
        }

        // é‡ç½®æ‰€æœ‰è®°å½•
        function resetAll() {
            if (confirm('âš ï¸ ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                data = {
                    totalDuty: 0,
                    usedRest: 0,
                    records: []
                };
                saveData();
                updateDisplay();
                renderRecords();
                alert('âœ… å·²é‡ç½®æ‰€æœ‰è®°å½•');
            }
        }
    </script>
</body>
</html>